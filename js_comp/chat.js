function __chat__(b){function m(a,d){var c=new Date;b.modals.preferences.chat_show_traffic&&b.addVisibleMessage("",a,"_"+d+"_",c)}function n(){e=new WebSocket(p);e.onopen=q;e.onerror=r;e.onclose=s;e.onmessage=t}window.WebSocket=window.WebSocket||window.MozWebSocket;window.WebSocket||console.log($("<p>",{text:"Sorry, but your browser doesn't support WebSockets."}));var p="ws://127.0.0.1:1337";this.isOnline=!0;var e,k=!0,g=this,h=new __helper__,l,q=function(){k=g.isOnline=!0;b.sstatus.favoriteRooms.forEach(function(a){g.sendUserJoin(a.roomId,
a.roomName)});l=new __room_proposer__(e,b._userName,b.sstatus.favoriteRooms,b);b.enableInput();setTimeout(function(){b.isStatusPersistent=!1;b.setCurrentStatus("Welcome back!","alert-success")},1E3)},r=function(a){g.isOnline=!1;console.log("Sorry, but there's some problem with your connection or the server is down.</p>")},s=function(){g.isOnline=!1;k&&(k=!1,b.disableInput(),b.sstatus.logChannelAttendees={},$("#channel-attendees-entries").empty(),b.isStatusPersistent=!0,b.setCurrentStatus("Awwr. It seems we got a server problem. We're working on it...",
"alert-error",-1));setTimeout(function(){n();console.log("retry")},3E4)},t=function(a){console.log("message received: "+JSON.stringify(a.data));a=JSON.parse(a.data);switch(a.intent){case "tell":b.addVisibleMessage(a.userName,a.roomName,a.content,a.time);break;case "tell-image":b.addVisibleImage(a.userName,a.roomName,a.content,a.time);break;case "attendees-list":g.updateAttendeesList(a.attendees,a.roomId,a.roomName);break;case "quit-room":var d=a.userId,c=a.userName;a=a.roomName;console.log("userquit:"+
d+" in "+a);if(void 0===b.sstatus.logChannelAttendees[a])console.log("userquit with undefined roomName");else{for(var f=0;f<b.sstatus.logChannelAttendees[a].length;++f)b.sstatus.logChannelAttendees[a][f].userId===d&&b.sstatus.logChannelAttendees[a].remove(f);a===h.getSimpleText(b._activeRoom)&&$("#channel-attendees-"+d).remove();m(a,c+" quit the room.")}break;case "join-room":d=a.userId;c=a.userName;a=a.roomName;console.log("userjoin:"+d+"="+c+" in "+a);void 0===b.sstatus.logChannelAttendees[a]&&
(b.sstatus.logChannelAttendees[a]=[]);b.sstatus.logChannelAttendees[a].push({userId:d,userName:c});a===h.getSimpleText(b._activeRoom)&&$("#channel-attendees-entries").append(b.makeAttendeeEntry(d,c));m(a,c+" joined the room.");break;case "room-proposals":l.handleIncomingRoomProposals(a.list);break;case "search-rooms":l.handleIncomingSearchResults(a.list,a.inputSource);break;default:console.log("Unknown `intent`.")}};n();this.updateAttendeesList=function(a,d,c){d=$("#channel-attendees-entries");c===
h.getSimpleText(b._activeRoom)&&d.empty();void 0===b.sstatus.logChannelAttendees[c]&&(b.sstatus.logChannelAttendees[c]=[]);var f=c===h.getSimpleText(b._activeRoom),e="";a.forEach(function(a){b.sstatus.logChannelAttendees[c].push({userId:a.userId,userName:a.userName});f&&(e+=b.makeAttendeeEntry(a.userId,a.userName))});d.append(e)};this.sendUserQuit=function(a,d){var c=$("#user-id").html();return function(a,d){e.send(JSON.stringify({intent:"quit-room",userId:c,userName:b._userName,roomId:a,roomName:d}))}}();
this.sendUserJoin=function(a,d){var c={intent:"join-room",userId:$("#user-id").html(),userName:b._userName,roomId:a,roomName:d};e.send(JSON.stringify(c))};this.sendMessage=function(a,b,c,f,g){e.send(JSON.stringify({content:a,intent:"tell",userId:b,userName:c,roomId:f,roomName:g}))};this.sendImage=function(a,b,c,f,g){a={content:a,intent:"tell-image",userId:b,userName:c,roomId:f,roomName:g};console.log(JSON.stringify(a));e.send(JSON.stringify(a))}};
